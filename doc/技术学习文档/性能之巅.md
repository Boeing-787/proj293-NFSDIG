# 性能分析方法总结
## 绪论
系统性能是对整个系统的研究，包括了所有的硬件组件和整个软件栈。所有数据路径上和软硬件上所发生的事情都包括在内，因为这 些都有可能影响性能。

性能领域包括了以下的事情，我按照理想的执行顺序将它们排列 如下： 
	1. 设置性能目标和建立性能模型 
	2. 基于软件或硬件原型进行性能特征归纳
	3. 对开发代码进行性能分析（软件整合之前）
	4. 执行软件非回归性测试（软件发布前或发布后）
	5. 针对软件发布版本的基准测试 
	6. 目标环境中的概念验证（Proof-of-concept）测试 
	7. 生产环境部署的配置优化 
	8. 监控生产环境中运行的软件 
	9. 特定问题的性能分析

**容量规划（capacity planning）**指的是一系列事前行动。在设 计阶段，包括通过研究开发软件的资源占用情况，来得知原有设计在 多大程度上能满足目标需求。在部署后，包括监控资源的使用情况， 这样问题在出现之前就能被预测。

+ 性能问题有许多视角：负载与资源
+ 性能问题可以是主观的
+ 性能问题是复杂的：真正的任务不是寻找问题，而是辨别问题或者说是 辨别哪些问题是最重要的。

## 性能
#### 概念
受测系统模型：
![[Pasted image 20250329101130.png]]
重要概念：
1. 延时：延时可以在不同点测量，所以通常我们会指明延时测量的对象。于延时是一个时间上的指标，因此可能有多种计算方法。性能 问题可以用延时来进行量化和评级，因为延时都用的是相同的单位来 表达的（时间）。
2. 权衡三角：性能、及时、便宜
3. 性能在在越靠近工作执行的地方效果最显著
4. 性能需要考虑合适的层级
5. 环境的性能特性会随着时间改变，更多的用户、新的硬件、升级 的软件或固件都是变化的因素。
6. 负载vs架构：应用程序性能差可能是因为软件配置和硬件的问题，也就是它的 架构问题。另外，应用程序性能差还可能是由于有太多负载，而导致 了排队和长延时。
7. 负载增加下的系统所展现的性能成为扩展性
8. 已知的已知，已知的未知，未知的未知
9. 使用率：基于时间&基于容量
10. 缓存：算法&冷热感知


#### 视角
资源分析与负载分析
##### 资源分析：
+ 性能问题研究 ：看是否某特定类型资源的责任。 
+  容量规划 ：为设计新系统提供信息，或者对系统资源何时会耗 尽做预测。
合适的指标有：
1. IOPS
2. 吞吐量
3. 使用率
4. 饱和度
##### 工作负载分析：
分析对象：
+ 请求
+ 延时：延时（响应时间）是体现应用程序性能最为重要的指标。
+ 完成度

#### 方法
##### 街灯讹方法：
用户选择熟悉的观测工具来分析性能，这些工具可能是从互联网上找到的，或者是用户随 意选择的，仅仅想看看会有什么结果出现。
##### 随机变动讹方法
用户随机猜测问题可能存在的位置，然后做改动，直到问题消失。为了判断性能是否已经提升，或者 作为每次变动结果的判断，用户会选择一项指标进行研究。

##### Ad Hoc 核对清单法
当需要检查和调试系统时，技术支持人员通常会花一点时间一步 步地过一遍核对清单。举个例子，这是核对清单中的一项：
>运行iostat -x 1 检 查await 列 。如果该列在负载下持续超过 10（ms），那么说明磁盘太慢或是磁盘过载。

##### 工具法：
工具为导向的方法如下： 
1. 列出可用到的性能工具（可选的，安装的或者可购买的）。 
2. 对于每一个工具，列出它提供的有用的指标。 
3. 对于每一个指标，列出阐释该指标可能的规则。

##### 业务负载画像

1. 确定负载来源：识别产生负载的具体实体，包括进程ID、用户ID、进程名以及IP地址等信息。这一步骤旨在明确是哪些主体或操作导致了当前的负载情况。
2. 分析负载成因：探究负载产生的根本原因，可能涉及代码执行路径、函数调用栈以及性能火焰图等技术手段。通过这些分析工具，可以深入了解系统在高负载状态下的行为模式和瓶颈所在。
3. 描述负载特征：对负载的构成进行详细刻画，涵盖IOPS（每秒输入输出次数）、吞吐量以及负载类型等多个维度。这有助于全面理解负载的性质和规模，为后续优化提供依据。
4. 监测负载变化趋势：跟踪负载随时间演化的动态过程，通过比较不同周期内的摘要信息，观察负载水平的变化规律及其背后的原因。这一步骤对于预测未来负载走势、制定合理的资源规划具有重要意义。

##### USE法：
**对于所有的资源，查看它的使用率、饱和度和错误。**
![[Pasted image 20250330114814.png]]
USE 方法是处理在高使用率或饱和状态下性能下降的资源最有效 的方法：
1. 找到资源列表
2. 考虑三类指标的观测
总体建议：
+ 使用率 ：100%的使用率通常是瓶颈的信号（检查饱和度并确认 其影响）。使用率超过60%可能会是问题，基于以下理由：时间间隔 的均值，可能掩盖了100%使用率的短期爆发，另外，一些资源，诸如 硬盘（不是CPU），通常在操作期间是不能被中断的，即使做的是优 先级较高的工作。随着使用率的上升，排队延时会变得更频繁和明 显。有更多关于60%使用率的内容，参见2.6.5 节。
+ 饱和度 ：任何程度的饱和都是问题（非零）。饱和程度可以用 排队长度或者排队所花的时间来度量。 
+ 错误： 错误都是值得研究的，尤其是随着错误增加性能会变差 的那些错误。
##### 工作负载特征归纳
1. 负载是 谁 产生的？进程ID、用户ID、远端的IP 地址？ 
2. 负载 为什么 会被调用？代码路径、堆栈跟踪？ 
3. 负载的特征是 什么 ？IOPS、吞吐量、方向类型（读取/写入）？ 包含变动（标准方差），如果有的话。 
4. 负载 是怎样 随着时间变化的？有日常模式吗？

##### 向下挖掘分析
1. 监测 ：用于持续记录高层级的统计数据，如果问题出现，予以 辨别和报警。 
2. 识别 ：对于给定问题，缩小研究的范围，找到可能的瓶颈。 
3. 分析 ：对特定的系统部分做进一步的检查，找到问题根源并量 化问题。
##### 延时分析
延时分析检查完成一项操作所用的时间，然后把时间再分成小的 时间段，接着对有着最大延时的时间段做再次的划分，最后定位并量 化问题的根本原因。与深度分析相同，延时分析也会深入到软件栈的 各层来找到延时问题的原因。


# 文件系统
**文件系统延时：**是文件系统性能一项主要的指标，指的是一个文件 系统逻辑请求从开始到结束的时间。一般的做法是使用内核跟踪工具打印出用户层发起文件系统逻辑I/O的调用栈，通过研究调用栈可以看出，应用程序里哪个函数 产生了I/O。

延时可以表示如下：
1. 单位时间平均值
2. 全分布
3. 单位操作延时
>对于缓存命中率高（大于99%）的文件系统，单位时间平均值可 能完全被缓存命中淹没。不幸的是，有些高延时（离群点）的个案虽 然很重要，但很难从平均值里看出。检查全分布、每个操作的延时以 及不同层延时的影响，包括文件系统缓存命中和未命中情况，可以帮 助挑出这些离群点以供调查。 一旦找到了高延时，继续向下挖掘分析文件系统以找到问题根源

### 负载特征归纳：
为了更好地归纳出特征，除了平均值还 要得到最大值。最好看看跨时段的全分布。文件系统负载需要归纳的几个基本属性：
1. 操作频率与操作类型
2. 文件IO吞吐量
3. 文件IO大小
4. 读写比例
5. 同步写比例
6. 随机与连续访问比例

高级负载特征归纳 / 检查清单：
1. 缓存命中率
2. 缓存多大，使用情况如何
3. 还使用了其他说明缓存？使用情况如何
4. 哪个应用程序或用户正在使用文件系统
5. 哪些文件和目录正在被访问，创建、删除
6. 碰到了什么错误吗？是不是由于一些非法请求，或者文件系统 自身的问题？
7. 要发起文件系统I/O（用户程序的调用路径）
8. 应用发起的文件系统I/O 中同步的比例占到多少
9. I/O 抵达时间的分布是怎样的？

性能特征归纳：
1. 文件系统操作的平均延时是多少
2. 是否有高延时的离群点
3. 操作延时的全分布是什么样的
4. 是否拥有并开启了文件系统或IO的系统资源流控

### 性能监控
主要的文件系统性能指标是：
+  操作频率
+  操作延时
操作频率是负载的最基本特征，而延时则是其性能结果。延时是 好是差，取决于负载、环境和延时需求。

可以只记录单个操作类型（读、写、统计、打开、关闭，等等） 的频率和延时数据。这对调查负载和性能变化有很大的帮助，因为可 以找出不同操作类型之间的差异。

### 事件跟踪
事件跟踪捕获文件系统每个操作的细节。这是观察分析最后的手段。**——增加了性能开销**

### 性能调优

##### 静态性能调优：
静态性能调优主要关注问题发生的配置环境。对于文件系统性 能，检查下面列出的静态配置情况：
● 挂载并当前使用了多少个文件系统？ ● 文件系统记录大小？ ● 启用了访问时间戳吗？ ● 还启用了哪些文件系统选项（压缩、加密等）？ ● 文件系统缓存是怎么配置的？最大缓存大小是多少？ ● 其他缓存（目录、inode、高速缓冲区）是怎么配置的？ ● 有二级缓存吗？用了吗？ ● 有多少个存储设备？用了几个？ ● 存储设备是怎么配置的？用了RAID 吗？ ● 用了哪种文件系统？ ● 用了哪个文件系统的版本（或者内核）？ ● 有什么需要考虑的文件系统bug/补丁？ ● 启用文件系统I/O 的资源控制了吗？

## 番外——微服务系统故障定位
+ 现代微服务系统中的故障诊断粒度是什么？故障诊断的问题怎么说？
+ 定义每种故障诊断技术的最重要特征和方法是什么？基于此，如何对每种技术进行分类并定性分析每个类别？
+ 在微服务系统的 AIOps 领域中，是否有用于故障诊断的公开数据集和工具包？他们的评价指标是什么？

## Practice
通常持续收集五种类型的可观察数据：日志、指标、跟踪、事件和拓扑