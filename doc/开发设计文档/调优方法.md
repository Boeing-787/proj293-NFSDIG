
# NFS调用指北

## 1. 包丢弃情况总结：
### 包被服务器丢弃
1. 适配器驱动程序（Adapter Driver）
当 NFS 服务器在对很多请求进行响应时，有时会从接口驱动程序输出队列中溢出。您可以使用 netstat -i 命令来观察所列出的统计信息。检查标记为 Oerrs 的那列，可以看到一些值。每一个 Oerrs 就是一个被丢弃的包。
2. UDP 套接字缓冲区。被丢弃的包在这里由 UDP 层来计数。
使用 netstat -p udp 命令可以显示相关的统计信息。其中标记为 UDP: 的就是套接字缓冲区溢出 信息。通常情况下，仅当服务器有很多 NFS 写流量时 NFS 包才在套接字缓冲区中被丢弃

## 2. 调优 NFS 文件属性高速缓存
每个缓存在 /proc/net/rpc 下注册一个目录，包含一个 channel 文件，用于内核与用户空间的通信。
用户空间通过 channel 文件读取请求并写入响应，填充缓存条目。

在 /etc/filesystems 文件中有五个参数可设置，用来控制某个指定条目在高速缓存中要保留多久。这些参数如下：
1. actimeo：在文件和目录条目被更新后，要在文件属性高速缓存中保留的绝对时间。如果被指定，则该值会覆盖 * min 和 * max 的值，事实上把它们都设成了 actimeo 的值。
2. acregmin：在文件条目被更新后，保留的最短时间。缺省值是 3 秒。
3. acregmax： 在文件条目被更新后，保留的最长时间。缺省值是 60 秒。
4. acdirmin：在目录条目被更新后，保留的最短时间。缺省值是 30 秒。
5. acdirmax：在目录条目被更新后，保留的最长时间。缺省值是 60 秒。
nfstest_cache
> 每次文件或目录被更新后，从高速缓存中移除至少要等 acregmin 或 acdirmin 秒。如果是第二次或后续的更新，条目最多被保留的时间至少等于最近两次更新之间的间隔时间，但是不会超过 acregmax 或 acdirmax 秒
挂载CacheFS：当一个文件系统被高速缓存以后，从远程文件系统或 CD-ROM 中读取的数据被存储到本地系统的高速缓存中，因此当需要再次读取已访问过的数据时就避免了对网络和 NFS 服务器的使用。CacheFS 被设计为一个分层的文件系统，这说明 CacheFS 提供了将一个文件系统（NFS 文件系统，又称为后台文件系统）缓存到另一文件系统（您的本地文件系统，又称为前台文件系统）上的功能

## 3. NFS 的 守护进程调优
rpc.lockd 守护进程是多线程的，缺省时最多可以创建 33 个线程。在 RPC 文件锁定性为频繁发生的情况下，当 rpc.lockd 守护进程一旦达到它的最大线程数时，它就可能成为一个瓶颈。修改nfsd线程数：检查 nullrecv 列，给列位于命令 nfsstat -s 的输出结果中。如果这个数字开始增长，那便说明 nfsd 守护进程的个数太多了(版本不对)
sudo echo  num | sudo tee /proc/fs/nfsd/threads

## 4. NFS 的磁盘配置：
大型的 NFS 服务器，常规策略是将磁盘 I/O 需求平均且最大限度地分配给多个磁盘和磁盘适配器。这样就能获得更大的并发性以及有能力运行更多的 nfsd 守护进程。在一个磁盘 I/O 有良好分布的系统上，可能会调整到一个状态，在这一状态上 CPU 负载成为服务器性能的限制因素。

## 5. 硬挂载和软挂载的性能推断
在成功的挂载后，当一个对软挂载（soft-mounted）目录的访问出错时（典型的是一个超时），这个错误被立即报告给原先请求远程访问的那个程序。当一个对硬挂载（hard-mounted）目录的访问出错时，NFS 重试原来的操作。

## 6. 其他影响性能的 mount 选项
1. rsize & wsize:减小 rsize 和 wsize 可以在一个比较拥塞的网络上通过向每个 NFS 请求发送较短的包列，从而提高 NFS 性能。但是带来一个副作用，就是需要更多的包在网络上发送数据，增加了网络的通信量，同时在服务器和客户机上都增加了 CPU 的开销。如果您的 NFS 文件系统是通过一个高速网络挂载的，如 SP Switch，则较大的读／写包能提高 NFS 文件系统的性能。在 NFS V3中，rsize 和 wsize 可以设置最大至 65536，缺省值是 32768。 在 NFS V2 中，rsize 和 rsize 最大可以达到 8192，同时这也是缺省值。
2. 通过release-behind提高连续 I/O 吞吐量:挂载文件系统时指定 combehind 标志 来打开延迟提交功能，该标志在 mount 命令中使用。您还需要为 numclust 变量设置一个适当的值。这个变量指定了虚拟内存管理（VMM）的连续延迟写算法所处理的 16KB 群集的数量。
3. 提高客户机大文件 I/O 吞吐量:
4. 禁用未被使用的 NFS ACL 支持: noacl选项
5. 硬挂载和软挂载两者哪个更好，这个问题关键在于要在一个给定的网络配置上寻求合适的超时持续时间。如果 timeouts 和 badxids 都是一个很大的数字（大于总数的 5%），您可以增加 timeo 参数

# NFS核对清单：
1. 查看您的服务器是否超负载运行。
2. 检查 Oerrs。
3. 查找任何错误
4. 检查 NFS UDP/TCP 缓冲区溢出。
5. 检查 mbuf 的问题。
6. 检查很小的网间包延迟
7. 检查传播媒介是否匹配
8. 检查 MTU 不匹配
9. 检查路由问题, 使用 traceroute 命令来查看无法预料的路由转发或延迟
10. 检查错误日志:运行 errpt 命令来查看网络设备或网络传输媒介的问题报告。还要寻找任何影响在导出文件系统上的 NFS 服务器性能的磁盘错误

# nfs挂载清单：
1. rw/ro:
描述: 读写（rw）或只读（ro）挂载

2. hard / soft
描述: 硬挂载（hard）或软挂载（soft）。
硬挂载: 如果服务器不可用，客户端会不断重试。
软挂载: 如果服务器不可用，客户端会立即返回错误。
示例: mount -t nfs server:/export /mnt -o hard

3. timeo=<value>
描述: 设置超时时间（以十分之一秒为单位），即客户端在放弃请求之前等待服务器响应的时间。
示例: mount -t nfs server:/export /mnt -o timeo=600

4. retrans=<value>
描述: 设置在放弃请求之前重试的次数。
示例: mount -t nfs server:/export /mnt -o retrans=3

5. rsize=<value>
描述: 设置读取数据时的最大数据块大小（以字节为单位）。
示例: mount -t nfs server:/export /mnt -o rsize=32768

6. wsize=<value>
描述: 设置写入数据时的最大数据块大小（以字节为单位）。
示例: mount -t nfs server:/export /mnt -o wsize=32768

7. vers=<version>
描述: 指定 NFS 协议版本（例如，vers=3 或 vers=4）。
示例: mount -t nfs server:/export /mnt -o vers=4

8. proto=<tcp|udp>
描述: 指定使用 TCP 或 UDP 协议。
示例: mount -t nfs server:/export /mnt -o proto=tcp

9. sec=<security_type>
描述: 指定安全类型（例如，sec=sys 或 sec=krb5）。
示例: mount -t nfs server:/export /mnt -o sec=sys

10. noacl
描述: 禁用 ACL（访问控制列表）支持。
示例: mount -t nfs server:/export /mnt -o noacl

11. actimeo=<value>
描述: 设置文件和目录属性缓存的绝对时间（以秒为单位）。
示例: mount -t nfs server:/export /mnt -o actimeo=30

12. acregmin=<value>
描述: 设置文件属性缓存的最小保留时间（以秒为单位）。
示例: mount -t nfs server:/export /mnt -o acregmin=5

13. acregmax=<value>
描述: 设置文件属性缓存的最大保留时间（以秒为单位）。
示例: mount -t nfs server:/export /mnt -o acregmax=60

14. acdirmin=<value>
描述: 设置目录属性缓存的最小保留时间（以秒为单位）。
示例: mount -t nfs server:/export /mnt -o acdirmin=30

15. acdirmax=<value>
描述: 设置目录属性缓存的最大保留时间（以秒为单位）。
示例: mount -t nfs server:/export /mnt -o acdirmax=60

16. noresvport
描述: 不使用保留端口进行通信。
示例: mount -t nfs server:/export /mnt -o noresvport

17. sync / async
描述: 同步（sync）或异步（async）写操作。
示例: mount -t nfs server:/export /mnt -o sync

18. nolock
描述: 禁用文件锁。
示例: mount -t nfs server:/export /mnt -o nolock

19. lock
描述: 启用文件锁。
示例: mount -t nfs server:/export /mnt -o lock

20. bg / fg
描述: 背景（bg）或前台（fg）挂载。
背景挂载: 如果服务器不可用，挂载命令会立即返回。
前台挂载: 如果服务器不可用，挂载命令会等待服务器可用。
示例: mount -t nfs server:/export /mnt -o bg

**调优参数更改途径：**
1. /etc/nfs.conf: NFS 客户端和服务器配置文件。
2. /proc/fs/nfsd
3. mount选项

**挂载选项更改，查看途径**
1. mount | grep nfs
2. mount -t nfs server:/export /mnt -o rw,hard,timeo=600,retrans=3,rsize=32768,wsize=32768,vers=4,proto=tcp,sec=sys （当前终端
3. 更改 /etc/fstab （永久保存挂载选项：
字段：远程主机，目录，本地目录，文件系统类型，挂载选项，备份选项，检查选项


