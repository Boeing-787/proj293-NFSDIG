# 故障模拟方案
https://bugzilla.redhat.com/show_bug.cgi?id=2176575
https://wiki.archlinux.org/title/Talk:NFS#Bad_config_file_for_server?
https://bugzilla.kernel.org/buglist.cgi?quicksearch=nfs
### 网络层面
1. 模拟网络延迟与丢包：借助网络模拟工具，如Linux系统的 netem 。以Ubuntu系统为例，先安装 iproute2 工具包（若未安装），执行命令 sudo apt install iproute2 。然后使用命令 sudo tc qdisc add dev <网卡名> root netem delay <延迟时间>ms loss <丢包率>% ，如 sudo tc qdisc add dev eth0 root netem delay 100ms loss 5% ，为指定网卡（eth0 ）添加100毫秒延迟和5% 丢包率，模拟网络不稳定。
2. 模拟网络中断：通过在网络设备（路由器、交换机）上配置访问控制列表（ACL），或在服务器上使用 iptables 等防火墙工具，临时阻断NFS客户端与服务器间的网络连接。例如在Linux服务器上执行 sudo iptables - I INPUT - s <NFS服务器IP> - j DROP ，丢弃来自NFS服务器的数据包，模拟网络中断；恢复连接则执行 sudo iptables - D INPUT - s <NFS服务器IP> - j DROP 。
### 服务器层面
1. 模拟服务器负载过高：利用压力测试工具，如 stress 。在NFS服务器上安装 stress ，以CentOS系统为例，执行 sudo yum install stress 。然后使用命令 stress - c <CPU核心数> - m <内存使用量MB> -- hdd <磁盘操作数> ，如 stress - c 4 - m 1024 -- hdd 10 ，模拟4个CPU核心满载、占用1024MB内存及10次磁盘操作，使服务器负载升高，影响NFS服务性能。
2. 模拟NFS服务异常：在NFS服务器上，使用命令停止或重启NFS服务。以Ubuntu系统为例，执行 sudo service nfs - kernel - server stop 停止服务，模拟服务故障；执行 sudo service nfs - kernel - server start 重启服务。也可修改NFS配置文件（如 /etc/exports ），错误配置共享目录权限等参数，引发NFS服务问题。
### 存储设备层面
1. 模拟磁盘I/O性能下降：使用 dd 命令对磁盘进行大量读写操作，占用磁盘带宽，模拟I/O性能下降。如执行 dd if=/dev/zero of=/mnt/nfs - mount - point/testfile bs=1M count=1000 ，在NFS挂载点（/mnt/nfs - mount - point ）创建一个1000MB的文件，大量占用磁盘I/O资源。
2. 模拟磁盘故障：在虚拟机环境下，可通过管理界面移除或断开虚拟磁盘与虚拟机的连接，模拟磁盘故障；在物理机上，可借助磁盘管理工具（如 smartctl ）对磁盘进行错误注入操作，但此操作有数据丢失风险，需谨慎操作且提前备份数据。
3. 模拟磁盘容量不够，利用quato设置底层文件系统配额

# 故障案例：
---
## 资源瓶颈引起的故障
1. 服务器因为过载停止服务：
主要还可以细分为CPU过载，内存过载和磁盘过载三方面，可以使用add_rtt脚本模拟 
2. 客户端过载而减慢nfs读写
主要可以使用add_rtt.sh脚本模拟
3. 网络接口硬件故障
使用add_rtt.sh脚本将接口MTU调极小
4. 本地文件系统故障
在服务端导出某一特定文件系统的故障，如ext4等
5. 模拟网络包在传输过程中发生数据损坏
6. nfs服务端需要DNS服务，但是DNS网络不通或过慢
7. 服务器突然崩溃但是文件锁尚未释放



## 配置引起的故障
1. 防火墙配置
使用add_rtt.sh脚本模拟
2. 挂载端口问题
默认secure导出，于是客户端只能从特权端口发起连接
3. 用户身份映射
导出配置决定nfs身份映射的行为，需要手动配置
4. 重复挂载
客户端同一个目录挂载两个服务端
5. 日志级别错误引起异常CPU指标

## 代码漏洞故障
1. 104861,"系统崩溃","NULL pointer dereference","https://bugzilla.kernel.org/attachment.cgi?id=209211&action=diff"
2. 206655,"兼容性问题","[NFS] multi path nfs does not work","不可重现","NFS sharecache 功能"
3. 109771,"缓存问题","NFSv4 cached attributes never expire when challenged via exec() family instead of stat()"， "https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ade14a7df796d4e86bd9d181193c883a57b13db0"
4. 194655,"挂载问题","nfsroot.c always sets root_server_addr, potentially overwriting value from dhcp/bootp"
5. 206573,"挂载时缓存问题","fscache/cachefiles on disk hash changes between mounts?","不可重现", "key->nfs_client = nfss->nfs_client;"
6. 215526,"端口分配行为异常问题","noresvport + nfsv4 no longer working as expected","不可重现","https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=468d126dab45718feeb728319be20bd869a5eaa7"

7. 217165,"属性的更新问题","NFS cache stops working if accessed from process with PPID of 1","不可重现","https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=21fd9e8700de86d1169f6336e97d7a74916ed04a"
8. 219911,"内存访问已释放的资源","kernel panic when starting nfsd on OpenWrt snapshot with kernel 6.12.19","不可重现", "https://lore.kernel.org/linux-nfs/75ec06ad-7472-4e83-a20e-28543ec2909d@oracle.com/T/#t"
9. 219710,"系统挂起","NFSD threads hang when destroying a session or client ID","不可重现","https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=961b4b5e86bf56a2e4b567f81682defa5cba957e and https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=036ac2778f7b28885814c6fbc07e156ad1624d03"
10. 

## 假设与逻辑错误
1. Blog1:https://blog.dend.ro/a-fun-nfs-bug/
2. Blog2:https://news.ycombinator.com/item?id=24749238