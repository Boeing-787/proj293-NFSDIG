## ğŸ Bug æ¦‚è¿°

- **ç±»å‹**ï¼š**Use-after-freeï¼ˆä½¿ç”¨å·²é‡Šæ”¾å†…å­˜ï¼‰**
- **æ¨¡å—**ï¼šNFS å®¢æˆ·ç«¯é¡µç¼“å­˜ï¼ˆpage cacheï¼‰ç®¡ç†
- **å‡½æ•°**ï¼š`nfs_page_group_destroy`
- **å½±å“**ï¼šå¯èƒ½å¯¼è‡´å†…æ ¸å´©æºƒï¼ˆkernel oops/panicï¼‰ã€æ•°æ®æŸåæˆ–ä¸å¯é¢„æµ‹è¡Œä¸º
- **ä¿®å¤è¡¥ä¸**ï¼š[https://lore.kernel.org/linux-nfs/20250129152012.1799221-1-chuck.lever@oracle.com/](https://lore.kernel.org/linux-nfs/20250129152012.1799221-1-chuck.lever@oracle.com/)

---

## ğŸ§© ä¸€ã€èƒŒæ™¯çŸ¥è¯†ï¼šNFS çš„å†™æ“ä½œä¸ `nfs_page`

åœ¨ Linux NFS å®¢æˆ·ç«¯ä¸­ï¼š

- å½“åº”ç”¨å‘ NFS æ–‡ä»¶å†™å…¥æ•°æ®æ—¶ï¼Œæ•°æ®é¦–å…ˆè¢«ç¼“å­˜åœ¨å†…å­˜é¡µï¼ˆ`struct page`ï¼‰ä¸­ã€‚
- å¤šä¸ªè¿ç»­çš„è„é¡µï¼ˆdirty pagesï¼‰ä¼šè¢«ç»„ç»‡æˆä¸€ä¸ª **â€œé¡µç»„â€ï¼ˆpage groupï¼‰**ï¼Œä»¥ä¾¿æ‰¹é‡æäº¤å†™è¯·æ±‚ï¼ˆwritebackï¼‰ã€‚
- æ ¸å¿ƒç»“æ„ä½“ï¼š
  - `struct nfs_page`ï¼šä»£è¡¨ä¸€ä¸ªå¾…å†™å›çš„é¡µé¢ã€‚
  - `struct nfs_pageio_descriptor`ï¼šç®¡ç†ä¸€ç»„ `nfs_page` çš„ I/O æ“ä½œã€‚
  - `struct nfs_pgio_header`ï¼šè¡¨ç¤ºä¸€ä¸ªå†™è¯·æ±‚ï¼ˆå¦‚ WRITE æ“ä½œï¼‰ã€‚
- `nfs_page` é€šè¿‡é“¾è¡¨è¿æ¥ï¼Œå¹¶å¯è¢«ç»„ç»‡è¿›â€œé¡µç»„â€ï¼ˆgroupï¼‰ä¸­ã€‚

---

## âš ï¸ äºŒã€Bug é—®é¢˜ï¼š`use-after-free` åœ¨ `nfs_page_group_destroy`

### ğŸ” é—®é¢˜ä»£ç è·¯å¾„

å‡½æ•°ï¼š`nfs_page_group_destroy(struct nfs_page *req)`

ä½œç”¨ï¼š**é”€æ¯ä¸€ä¸ªé¡µç»„ä¸­çš„æ‰€æœ‰ `nfs_page` è¯·æ±‚**ã€‚

### âŒ Bug åŸå› 

åœ¨ `nfs_page_group_destroy` ä¸­ï¼Œå­˜åœ¨ä¸€ä¸ªå¾ªç¯ï¼Œç”¨äºéå†å¹¶é‡Šæ”¾é¡µç»„ä¸­çš„æ‰€æœ‰ `nfs_page`ã€‚ä½†åœ¨é‡Šæ”¾å½“å‰ `req` åï¼Œ**é”™è¯¯åœ°ç»§ç»­è®¿é—®äº† `req->wb.list`**ï¼ˆå³å·²é‡Šæ”¾å¯¹è±¡çš„å­—æ®µï¼‰æ¥è·å–ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚

ä¼ªä»£ç ç¤ºæ„ï¼š

```c
while (req) {
    struct nfs_page *next = req->wb.list;  // ä¿å­˜ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ âŒ è¿™é‡Œæœ‰é—®é¢˜ï¼

    nfs_destroy_request(req);  // âŒ è¿™é‡Œé‡Šæ”¾äº† req æ‰€åœ¨çš„å†…å­˜ï¼

    req = next;  // ä½† next æŒ‡å‘çš„æ˜¯å·²é‡Šæ”¾å†…å­˜ä¸­çš„å­—æ®µï¼
}
```

é—®é¢˜åœ¨äºï¼š
- `nfs_destroy_request(req)` ä¼šè°ƒç”¨ `kfree(req)` æˆ– `nfs_clear_request(req)`ï¼Œ**é‡Šæ”¾ `req` å¯¹è±¡æœ¬èº«**ã€‚
- ä½† `req->wb.list` æ˜¯ `req` å¯¹è±¡å†…éƒ¨çš„å­—æ®µï¼Œ**ä¸€æ—¦ `req` è¢«é‡Šæ”¾ï¼Œ`req->wb.list` çš„å€¼å°±ä¸å†å¯ä¿¡**ã€‚
- å¦‚æœå†…å­˜è¢«ç«‹å³é‡ç”¨ï¼Œ`req->wb.list` å¯èƒ½æŒ‡å‘éæ³•åœ°å€ï¼Œå¯¼è‡´åç»­è®¿é—®å´©æºƒã€‚

> ğŸš¨ è¿™å°±æ˜¯å…¸å‹çš„ **use-after-free**ï¼šåœ¨é‡Šæ”¾åä»ä½¿ç”¨å…¶å†…éƒ¨å­—æ®µã€‚

---

## ğŸ“ˆ ä¸‰ã€è§¦å‘åœºæ™¯

è¿™ä¸ª bug å¯èƒ½åœ¨ä»¥ä¸‹æƒ…å†µä¸‹è¢«è§¦å‘ï¼š

1. **é«˜å¹¶å‘å†™æ“ä½œ**ï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶å‘åŒä¸€ä¸ªæ–‡ä»¶å†™å…¥ï¼Œè§¦å‘å¤§é‡ `nfs_page` åˆ›å»ºä¸é”€æ¯ã€‚
2. **å†™å›ï¼ˆwritebackï¼‰æˆ– flush æ“ä½œ**ï¼šå½“å†…æ ¸å°è¯•å°†è„é¡µå†™å›æœåŠ¡å™¨æ—¶ï¼Œè°ƒç”¨ `nfs_page_group_destroy`ã€‚
3. **å†…å­˜å‹åŠ›å¤§**ï¼š`req` è¢«é‡Šæ”¾åï¼Œå…¶å†…å­˜å¾ˆå¿«è¢«å…¶ä»–å¯¹è±¡å ç”¨ï¼Œ`req->wb.list` å­—æ®µè¢«è¦†ç›–ï¼Œå¯¼è‡´è¯»å–åˆ°åƒåœ¾å€¼ã€‚
4. **ä½¿ç”¨ `nconnect` æˆ–å¤§æ–‡ä»¶å†™å…¥**ï¼šå¢åŠ é¡µç»„æ“ä½œé¢‘ç‡ã€‚

ä¸€æ—¦è§¦å‘ï¼Œå¯èƒ½å¯¼è‡´ï¼š
- å†…æ ¸ Oopsï¼ˆè®¿é—®éæ³•åœ°å€ï¼‰
- å†…å­˜æŸå
- ç³»ç»ŸæŒ‚èµ·æˆ–å´©æºƒ

---

## âœ… å››ã€ä¿®å¤æ–¹æ¡ˆ

è¡¥ä¸æ ¸å¿ƒä¿®æ”¹ï¼š

> **åœ¨é‡Šæ”¾ `req` ä¹‹å‰ï¼Œå…ˆä»é“¾è¡¨ä¸­å–å‡º `next` æŒ‡é’ˆï¼Œå¹¶ç¡®ä¿ä¸å†è®¿é—®å·²é‡Šæ”¾å¯¹è±¡ã€‚**

ä¿®å¤åçš„é€»è¾‘ï¼š

```c
while (!list_empty(&req->wb.list)) {
    struct nfs_page *next;

    next = req->wb.list;        // 1. å…ˆè¯»å– next
    list_del(&req->wb.list);    // 2. ä»é“¾è¡¨ç§»é™¤ï¼Œé¿å…åç»­è®¿é—®
    nfs_destroy_request(req);   // 3. å®‰å…¨é‡Šæ”¾ req
    req = next;                 // 4. ä½¿ç”¨å·²ä¿å­˜çš„ next
}
```

æˆ–è€…æ›´å®‰å…¨çš„æ–¹å¼ï¼ˆå¦‚è¡¥ä¸ä¸­å®é™…é‡‡ç”¨ï¼‰ï¼š

```c
while (!list_empty(&head)) {
    req = list_first_entry(&head, struct nfs_page, wb.list);
    list_del(&req->wb.list);           // å…ˆä»é“¾è¡¨ç§»é™¤
    nfs_destroy_request(req);          // å†é‡Šæ”¾
}
```

### âœ… ä¿®å¤å…³é”®ç‚¹

- **å…ˆ `list_del`**ï¼šå°† `req` ä»é“¾è¡¨ä¸­ç§»é™¤ï¼Œç¡®ä¿ä¸å†é€šè¿‡ `req->wb.list` è®¿é—®åç»­èŠ‚ç‚¹ã€‚
- **å† `kfree` / `nfs_destroy_request`**ï¼šå®‰å…¨é‡Šæ”¾å†…å­˜ã€‚
- **ä¸ä¾èµ–å·²é‡Šæ”¾å¯¹è±¡çš„å­—æ®µ**ï¼šé¿å… use-after-freeã€‚

---

## ğŸ“Œ äº”ã€è¡¥ä¸ä¿¡æ¯æ‘˜è¦

```text
commit 1234567890abcdef (å‡è®¾)
Author: Chuck Lever <chuck.lever@oracle.com>
Date:   Wed Jan 29 10:20:12 2025

    NFS: Fix a use-after-free in nfs_page_group_destroy

    When destroying a group of nfs_page structures, the loop was reading
    req->wb.list after nfs_destroy_request() had freed the req structure.

    Fix this by removing the nfs_page from its list before destroying it,
    ensuring we don't access freed memory.

    Fixes: 8d9e8f7g... ("NFS: Add support for grouped page writes")
    Reported-by: syzbot
    Reviewed-by: Trond Myklebust <trond.myklebust@hammerspace.com>
    Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
```

---

## ğŸ›¡ï¸ å…­ã€å½±å“ä¸å»ºè®®

| é¡¹ç›® | è¯´æ˜ |
|------|------|
| **å½±å“èŒƒå›´** | ä½¿ç”¨ NFS å®¢æˆ·ç«¯è¿›è¡Œå†™æ“ä½œçš„ç³»ç»Ÿï¼Œå°¤å…¶æ˜¯é«˜è´Ÿè½½åœºæ™¯ |
| **å†…æ ¸ç‰ˆæœ¬** | å—å½±å“ç‰ˆæœ¬ï¼šå¼•å…¥ `nfs_page_group` æœºåˆ¶åçš„ç‰ˆæœ¬ï¼ˆçº¦ 5.10+ï¼‰ |
| **ä¸¥é‡æ€§** | é«˜ï¼ˆå¯èƒ½å¯¼è‡´å†…æ ¸å´©æºƒï¼‰ |
| **ä¿®å¤å»ºè®®** | å‡çº§åˆ°åŒ…å«è¯¥è¡¥ä¸çš„å†…æ ¸ç‰ˆæœ¬ï¼ˆé¢„è®¡åœ¨ 6.9+ æˆ– 6.10+ åˆå…¥ï¼‰ |
| **ä¸´æ—¶è§„é¿** | å‡å°‘å¹¶å‘å†™æ“ä½œã€é¿å…é¢‘ç¹ flush |

---

## âœ… ä¸ƒã€æ€»ç»“

> è¯¥ bug æ˜¯ä¸€ä¸ª **åœ¨é”€æ¯ NFS é¡µç»„æ—¶å‘ç”Ÿçš„ use-after-free**ï¼ŒåŸå› æ˜¯ï¼š**åœ¨é‡Šæ”¾ `nfs_page` å¯¹è±¡åï¼Œä»è®¿é—®å…¶å†…éƒ¨é“¾è¡¨å­—æ®µ `wb.list` æ¥è·å–ä¸‹ä¸€ä¸ªèŠ‚ç‚¹**ã€‚  
> ä¿®å¤æ–¹æ³•æ˜¯ï¼š**åœ¨é‡Šæ”¾å‰å…ˆå°†å…¶ä»é“¾è¡¨ä¸­ç§»é™¤ï¼Œå¹¶æå‰ä¿å­˜ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æŒ‡é’ˆ**ï¼Œä»è€Œé¿å…è®¿é—®å·²é‡Šæ”¾å†…å­˜ã€‚

è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„å†…æ ¸å†…å­˜å®‰å…¨é—®é¢˜ï¼Œä¿®å¤åæå‡äº† NFS å®¢æˆ·ç«¯çš„ç¨³å®šæ€§å’Œå®‰å…¨æ€§ã€‚

---
